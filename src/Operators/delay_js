//@flow

import { Subscription } from '../Utils/Subscription';
import { ValueConnection } from '../ValueConnection';
import { Value } from '../Value';
import { ValueLayzy } from '../ValueLayzy';
import { Timer } from '../Utils/Timer';

export const delay = <T>(
    parentBind: () => ValueConnection<T>,
    timeout: number
): [() => Subscription, () => T] => {
    type InnerType = {
        subscription: Subscription,
        timers: Array<Timer>,
        connection: ValueLayzy<ValueConnection<T>>,
    };

    const inner: ValueLayzy<InnerType> = new ValueLayzy({
        create: (): InnerType => {
            const subscription = new Subscription();
    
            const connection: ValueLayzy<ValueConnection<T>> = new ValueLayzy({
                create: () => parentBind(),
                drop: (conn) => conn.disconnect()
            });

            const TimerList: TimerList = new TimerList();
    
            const value = new ValueLayzy({
                create: () => connection.getValue().getValue(),
                drop: null
            });

            return {
                subscription,
                timers: TimerList,
                value,
                connection
            };
        },
        drop: (inner: InnerType) => {
            inner.TimerList.clear();
            inner.connection.clear();
        }
    });

    inner.onNew((innerValue: InnerType) => {
        innerValue.subscription.onDown(() => {
            inner.clear();
        });

        innerValue.TimerList.onNew((timer: Timer) => {
            const valueSnapshot = innerValue.connection.getValue().getValue()

            timer.onReady(() => {
                //innerValue.value.clear();
                value.set(valueSnapshot);
                innerValue.subscription.notify();
            });
        });

        innerValue.connection.onNew((connectionInner) => {
            connectionInner.onNotify(() => {
                innerValue.timer.createNew();
            });
        })
    });

    return [
        (): Subscription => inner.getValue().subscription,
        (): T => inner.getValue().value.getValue()
    ];
};
